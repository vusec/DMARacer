version: '3'

tasks:
  run-bench:
    desc: run syzkaller fuzzer and record execution statistics
    cmds:
      - task syzkaller:prep-run
      - rm -f $ROOT/out/syzkaller-bench
      - $SYZKALLER_BIN/syz-manager -config=$SYZKALLER_CFG --bench $ROOT/out/syzkaller-bench

  run-nobench:
    desc: run syzkaller fuzzer and _do not_ record execution statistics
    cmds:
      - task syzkaller:prep-run
      - $SYZKALLER_BIN/syz-manager -config=$SYZKALLER_CFG

  run-debug:
    desc: run syzkaller fuzzer in -debug mode (i.e., 1 VM, with verbose logging)
    cmds:
      - task syzkaller:prep-run
      - $SYZKALLER_BIN/syz-manager -config=$SYZKALLER_CFG -debug

  prep-run:
    cmds:
      - test $SYZKALLER_LOGS_PATH
      - rm -rf $SYZKALLER_LOGS_PATH
      - mkdir -p $SYZKALLER_LOGS_PATH

  cfg-prereqs:
    desc: downloads mustache.go, which is needed to generate a syzkaller cfg
    status:
      - test -f $GOPATH/bin/mustache
    cmds:
      - env --unset=CC go install github.com/cbroglie/mustache/cmd/mustache@latest

  cfg-init:
    desc: generates a syzkaller cfg based on the template cfg
    vars:
      KERNEL: 'KERNEL: $KERNEL'
      KERNEL_IMAGE: 'KERNEL_IMAGE: $KERNEL_IMAGE'
      ARCH: 'ARCH: $ARCH'
      SYZARCH: 'SYZARCH: $SYZARCH'
      SYZKALLER_PREFIX: 'SYZKALLER_PREFIX: $SYZKALLER_PREFIX'
      SYZKALLER_WORKDIR: 'SYZKALLER_WORKDIR: {{.ROOT}}/out/syzkaller-workdir'
      SYZKALLER_IMG: 'SYZKALLER_IMG: $SYZKALLER_IMG'
      SYZKALLER_LOGS_PATH: 'SYZKALLER_LOGS_PATH: $SYZKALLER_LOGS_PATH'
      SYZKALLER_QEMU_ARGS: 'SYZKALLER_QEMU_ARGS: $SYZKALLER_QEMU_ARGS'
      TEMPLATE_DATA: "{{.KERNEL}}\n{{.KERNEL_IMAGE}}\n{{.ARCH}}\n{{.SYZARCH}}\n{{.SYZKALLER_PREFIX}}\n{{.SYZKALLER_WORKDIR}}\n{{.SYZKALLER_IMG}}\n{{.SYZKALLER_LOGS_PATH}}\n{{.SYZKALLER_QEMU_ARGS}}"
    cmds:
      - task syzkaller:cfg-prereqs
      - echo "{{.TEMPLATE_DATA}}" | $GOPATH/bin/mustache $SYZKALLER_CFG_TEMPLATE > $SYZKALLER_CFG

  build:
    desc: build syzkaller
    cmds:
      - task syzkaller:cfg-init
      - mkdir -p $ROOT/out/go/src/github.com/google $GOBIN
      - ln -sfn $SYZKALLER_PREFIX $ROOT/out/go/src/github.com/google/syzkaller
      - cd $SYZKALLER_PREFIX && make TARGETARCH=$SYZARCH -j${NPROC}

  create-image:
    desc: create syzkaller image
    cmds:
      - mkdir -p $SYZKALLER_IMG
      - cp scripts/syzkaller-create-image.sh $SYZKALLER_IMG/create-image.sh
      - cd $SYZKALLER_IMG && ADD_PACKAGE="python3-pip,python-is-python3,make,iperf,unzip,libjpeg-dev,libpng-dev,moreutils,gnome-shell,dbus-user-session,xinit,git,xorg,g++,pkg-config,cmake,libx11-dev,mesa-utils,btrfs-progs,util-linux,jfsutils,ntfs-3g,reiserfsprogs,meson,xfsprogs,alsa-utils" ./create-image.sh -a $DEBARCH -f full
      - cd $SYZKALLER_IMG && cp bullseye.img bullseye.img.bak
